<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGen AI - Live Generation (Pollinations)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; scroll-behavior: smooth; }
        
        .step-content { display: none; }
        .step-content.active { display: flex; animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .style-card { border: 3px solid transparent; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .style-card.selected { border-color: #4f46e5; background: #eef2ff; transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.3); }
        .style-card.selected::after { content: 'âœ“'; position: absolute; top: 12px; right: 12px; background: #4f46e5; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .tab-btn { border-bottom: 3px solid transparent; color: #94a3b8; transition: all 0.2s; }
        .tab-btn.active-tab { border-color: #4f46e5; color: #4f46e5; font-weight: 800; }
        
        .input-group label { display: block; font-size: 0.75rem; font-weight: 800; color: #64748b; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .input-group input, .input-group select { width: 100%; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.75rem; font-weight: 600; outline: none; transition: 0.2s; }
        .input-group input:focus, .input-group select:focus { border-color: #6366f1; background: white; ring: 2px solid #e0e7ff; }
        
        .chat-bubble { max-width: 85%; padding: 1.2rem; border-radius: 1.5rem; margin-bottom: 1rem; position: relative; line-height: 1.6; font-size: 1.05rem; }
        .ai-bubble { background: #eef2ff; color: #3730a3; border-bottom-left-radius: 0.2rem; }
        .user-bubble { background: #4f46e5; color: white; border-bottom-right-radius: 0.2rem; align-self: flex-end; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden min-h-screen flex flex-col">

    <header class="w-full bg-white/80 backdrop-blur-md border-b px-12 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="location.reload()">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black text-xl group-hover:rotate-12 transition-transform">E</div>
            <h1 class="text-2xl font-black text-slate-800 tracking-tight">EduGen <span class="text-indigo-600">AI</span></h1>
        </div>
        <nav class="flex items-center gap-2">
            <div id="nav1" class="px-4 py-2 rounded-full text-xs font-bold bg-indigo-600 text-white transition-all">1. ìŠ¤íƒ€ì¼/ê·œê²©</div>
            <div class="w-8 h-[2px] bg-slate-200"></div>
            <div id="nav2" class="px-4 py-2 rounded-full text-xs font-bold text-slate-400 bg-slate-100 transition-all">2. í”„ë¡¬í”„íŠ¸</div>
            <div class="w-8 h-[2px] bg-slate-200"></div>
            <div id="nav3" class="px-4 py-2 rounded-full text-xs font-bold text-slate-400 bg-slate-100 transition-all">3. ìƒì„±/í™•ì¸</div>
            <div class="w-8 h-[2px] bg-slate-200"></div>
            <div id="nav4" class="px-4 py-2 rounded-full text-xs font-bold text-slate-400 bg-slate-100 transition-all">4. ë¶€ë¶„ ìˆ˜ì •</div>
            <div class="w-8 h-[2px] bg-slate-200"></div>
            <div id="nav5" class="px-4 py-2 rounded-full text-xs font-bold text-slate-400 bg-slate-100 transition-all">5. ì™„ë£Œ</div>
        </nav>
    </header>

    <main class="flex-1 p-8 max-w-[1400px] mx-auto w-full pb-32">

        <div id="step1" class="step-content active flex-col gap-8">
            <div class="text-center mb-6">
                <span class="text-indigo-600 font-bold tracking-widest text-xs uppercase mb-2 block">Step 1 of 5</span>
                <h2 class="text-4xl font-black mb-3">ì–´ë–¤ ìŠ¤íƒ€ì¼ì˜ ì´ë¯¸ì§€ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?</h2>
                <p class="text-slate-500 text-lg">êµì¬ì˜ ì„±ê²©ì— ë§ëŠ” í™”í’ê³¼ ì¸ì‡„ ê·œê²©ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
            </div>
            
            <div class="grid grid-cols-4 gap-6">
                <div onclick="selectStyle(this, 'Photorealistic, 8k, highly detailed')" class="style-card bg-white p-4 rounded-[2rem] shadow-sm hover:shadow-xl selected">
                    <img src="https://picsum.photos/seed/nature/600/450" class="rounded-2xl w-full aspect-[4/3] object-cover mb-4">
                    <h4 class="font-bold text-center text-lg">ì‹¤ì‚¬ ì‚¬ì§„ (Non-fiction)</h4>
                </div>
                <div onclick="selectStyle(this, 'Flat vector art, clean lines, minimal')" class="style-card bg-white p-4 rounded-[2rem] shadow-sm hover:shadow-xl">
                    <img src="https://picsum.photos/seed/art/600/450" class="rounded-2xl w-full aspect-[4/3] object-cover mb-4">
                    <h4 class="font-bold text-center text-lg">í•™ìŠµ ì¼ëŸ¬ìŠ¤íŠ¸ (Flat)</h4>
                </div>
                <div onclick="selectStyle(this, 'Watercolor painting, soft pastel colors, artistic')" class="style-card bg-white p-4 rounded-[2rem] shadow-sm hover:shadow-xl">
                    <img src="https://picsum.photos/seed/paint/600/450" class="rounded-2xl w-full aspect-[4/3] object-cover mb-4">
                    <h4 class="font-bold text-center text-lg">ë¶€ë“œëŸ¬ìš´ ìˆ˜ì±„í™”</h4>
                </div>
                <div onclick="selectStyle(this, 'Technical diagram, schematic, blueprint style, colorful')" class="style-card bg-white p-4 rounded-[2rem] shadow-sm hover:shadow-xl">
                    <img src="https://picsum.photos/seed/tech/600/450" class="rounded-2xl w-full aspect-[4/3] object-cover mb-4">
                    <h4 class="font-bold text-center text-lg">ê°œë… ë„íŒ/ë‹¤ì´ì–´ê·¸ë¨</h4>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 flex gap-8 items-end">
                <div class="input-group flex-1">
                    <label>ì¶œë ¥ ë¹„ìœ¨ (Aspect Ratio)</label>
                    <select id="aspectRatio" class="text-lg py-3 cursor-pointer hover:border-indigo-400">
                        <option value="1:1">1:1 (ì •ì‚¬ê°í˜•)</option>
                        <option value="4:3" selected>4:3 (í‘œì¤€ êµì¬)</option>
                        <option value="16:9">16:9 (ì™€ì´ë“œ)</option>
                        <option value="2:3">2:3 (ì„¸ë¡œí˜•)</option>
                    </select>
                </div>
                <div class="input-group flex-1">
                    <label>ìµœì¢… í•´ìƒë„</label>
                    <select class="text-lg py-3 cursor-pointer hover:border-indigo-400">
                        <option>Standard (72DPI - ì›¹ìš©)</option>
                        <option selected>Print High-Res (300DPI - ì¸ì‡„ìš©)</option>
                        <option>Ultra-HD (600DPI - ëŒ€í˜• ì‹¤ì‚¬)</option>
                    </select>
                </div>
            </div>

            <button onclick="nextStep(2)" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-bold text-xl shadow-lg hover:bg-black hover:scale-[1.01] transition transform">ë‹¤ìŒ ë‹¨ê³„ë¡œ (ì…ë ¥ ë°©ì‹ ì„ íƒ) â†’</button>
        </div>

        <div id="step2" class="step-content flex-col gap-6">
            <div class="text-center mb-2">
                <span class="text-indigo-600 font-bold tracking-widest text-xs uppercase mb-2 block">Step 2 of 5</span>
                <h2 class="text-4xl font-black mb-2">ì›í•˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë¬˜ì‚¬í•´ì£¼ì„¸ìš”</h2>
            </div>
            
            <div class="flex border-b-2 border-slate-200 mb-2">
                <button onclick="switchTab('free')" id="tab-free" class="tab-btn active-tab flex-1 py-4 text-lg font-bold">ğŸ’¬ ììœ  ëŒ€í™” ëª¨ë“œ</button>
                <button onclick="switchTab('structured')" id="tab-structured" class="tab-btn flex-1 py-4 text-lg font-bold">ğŸ“‹ ìƒì„¸ í•­ëª© ì…ë ¥</button>
            </div>

            <div id="content-free" class="flex flex-col gap-4 h-[600px]">
                <div class="bg-slate-50 rounded-[2.5rem] p-8 flex-1 overflow-y-auto flex flex-col gap-4 border border-slate-200 shadow-inner" id="chatWindow">
                    <div class="chat-bubble ai-bubble">
                        ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”! ì„¤ì •í•˜ì‹  ìŠ¤íƒ€ì¼ë¡œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ë“œë¦´ê²Œìš”.<br>
                        ì–´ë–¤ ì´ë¯¸ì§€ê°€ í•„ìš”í•˜ì‹ ê°€ìš”? (ì˜ˆ: "ëˆˆ ë‚´ë¦¬ëŠ” ìˆ²ì†ì˜ ì˜¤ë‘ë§‰")
                    </div>
                </div>
                <div class="relative mt-2">
                    <textarea id="freeInput" class="w-full p-6 pr-32 bg-white border-2 border-indigo-100 rounded-[2rem] text-xl shadow-lg outline-none focus:border-indigo-500 h-24 resize-none transition-all" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..." onkeydown="if(event.keyCode==13 && !event.shiftKey) {event.preventDefault(); sendMessage();}"></textarea>
                    <button onclick="sendMessage()" class="absolute right-3 top-3 bottom-3 px-8 bg-indigo-600 text-white rounded-[1.5rem] font-bold hover:bg-indigo-700 transition shadow-md">ì „ì†¡</button>
                </div>
            </div>

            <div id="content-structured" class="hidden bg-white p-10 rounded-[2.5rem] border shadow-sm">
                <div class="grid grid-cols-4 gap-6 mb-8">
                    <div class="input-group"><label>1. í”¼ì‚¬ì²´</label><input type="text" id="s_subject" placeholder="ì˜ˆ: ë‹¤ëŒì¥"></div>
                    <div class="input-group"><label>2. ë™ì‘</label><input type="text" id="s_action" placeholder="ì˜ˆ: ë„í† ë¦¬ë¥¼ ë¨¹ëŠ”"></div>
                    <div class="input-group"><label>3. í‘œì •</label><input type="text" id="s_expression" placeholder="ì˜ˆ: í–‰ë³µí•œ"></div>
                    <div class="input-group"><label>4. ì‹œì„ </label><select id="s_gaze"><option>ì •ë©´ ì‘ì‹œ</option><option>ë¨¼ ê³³ ë³´ê¸°</option></select></div>
                </div>
                <div class="grid grid-cols-4 gap-6">
                    <div class="input-group"><label>5. ì¥ì†Œ</label><input type="text" id="s_location" placeholder="ì˜ˆ: ìˆ²ì†"></div>
                    <div class="input-group"><label>6. ë¶„ìœ„ê¸°</label><input type="text" id="s_mood" placeholder="ì˜ˆ: í™”ì°½í•œ"></div>
                </div>
            </div>

            <button id="finalGenBtn" onclick="nextStep(3)" class="hidden w-full py-5 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-2xl font-black text-xl shadow-xl hover:shadow-2xl transition transform hover:-translate-y-1">âœ¨ ì‹¤ì œ AI ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ (Pollinations)</button>
        </div>

        <div id="step3" class="step-content flex-col gap-8">
            <h2 class="text-3xl font-black">3ë‹¨ê³„. ìƒì„± ê²°ê³¼ í™•ì¸</h2>
            <div class="grid grid-cols-2 gap-10 h-[600px]">
                
                <div class="relative group w-full h-full bg-slate-100 rounded-[2.5rem] overflow-hidden shadow-inner flex items-center justify-center">
                    <div id="imageLoading" class="absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center text-white transition-opacity duration-300">
                        <div class="loader mb-6 border-t-indigo-400"></div>
                        <h3 id="loadingText" class="text-xl font-bold tracking-widest animate-pulse uppercase">Generating with AI...</h3>
                        <p class="text-sm mt-4 text-slate-400">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (ì•½ 5~10ì´ˆ)</p>
                    </div>
                    
                    <img id="resultImage" src="" crossorigin="anonymous" class="w-full h-full object-contain bg-slate-800 transition-transform duration-700 hover:scale-105">
                    
                    <div class="absolute bottom-6 right-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-4 group-hover:translate-y-0">
                        <button class="bg-white/90 backdrop-blur text-slate-800 px-5 py-2 rounded-xl font-bold text-sm shadow-lg hover:bg-white flex items-center gap-2">ğŸ” í™•ëŒ€í•˜ê¸°</button>
                    </div>
                </div>

                <div class="flex flex-col justify-center h-full gap-6">
                    <div class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm">
                        <h4 class="text-indigo-600 font-bold mb-6 uppercase text-xs tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 bg-indigo-600 rounded-full animate-pulse"></span> AI Generation Report
                        </h4>
                        <div class="space-y-4 text-lg text-slate-700">
                            <div class="flex justify-between border-b border-slate-100 pb-3"><span>ëª¨ë¸ ì—”ì§„</span><span class="font-bold text-indigo-600">Pollinations AI</span></div>
                            <div class="flex justify-between border-b border-slate-100 pb-3"><span>ì¸ì‡„ ì í•©ì„±</span><span class="text-emerald-500 font-bold flex items-center gap-1">Pass (300DPI) âœ“</span></div>
                            <div class="flex justify-between"><span>ìƒíƒœ</span><span class="font-bold">Generation Complete</span></div>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-[2rem] p-6 border border-slate-200 shadow-inner">
                        <p class="text-sm font-bold text-slate-500 mb-4 flex items-center gap-2">ğŸ¤” ê²°ê³¼ê°€ ë§ˆìŒì— ë“¤ì§€ ì•Šìœ¼ì‹ ê°€ìš”?</p>
                        <div class="flex gap-3 mb-4">
                            <button onclick="regenerateImage(false)" class="flex-1 py-4 bg-white border-2 border-slate-200 text-slate-600 rounded-2xl font-bold hover:border-indigo-400 hover:text-indigo-600 transition flex items-center justify-center gap-2 shadow-sm">
                                <span class="text-xl">ğŸ”„</span> ë‹¤ë¥¸ êµ¬ë„ë¡œ (Re-roll)
                            </button>
                            <button onclick="toggleTweak()" class="flex-1 py-4 bg-white border-2 border-slate-200 text-slate-600 rounded-2xl font-bold hover:border-indigo-400 hover:text-indigo-600 transition flex items-center justify-center gap-2 shadow-sm">
                                <span class="text-xl">âœï¸</span> ë‚´ìš© ìˆ˜ì • (Tweak)
                            </button>
                        </div>

                        <div id="tweakArea" class="hidden overflow-hidden transition-all duration-300">
                            <textarea id="tweakInput" class="w-full p-4 text-sm border-2 border-indigo-100 rounded-xl mb-3 focus:outline-none focus:border-indigo-500 bg-white resize-none" rows="3" placeholder="ì—¬ê¸°ì— ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            <button onclick="regenerateImage(true)" class="w-full py-3 bg-slate-800 text-white text-sm font-bold rounded-xl hover:bg-black transition">ìˆ˜ì •ëœ ë‚´ìš©ìœ¼ë¡œ ë‹¤ì‹œ ìƒì„±</button>
                        </div>
                    </div>

                    <button onclick="nextStep(4)" class="w-full py-5 bg-indigo-600 text-white rounded-[2rem] font-black text-xl shadow-xl hover:bg-indigo-700 transition transform hover:scale-[1.02] flex items-center justify-center gap-2 group">
                        ì´ ì´ë¯¸ì§€ë¡œ í™•ì •í•˜ê¸° 
                        <span class="group-hover:translate-x-1 transition-transform">â†’</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="step4" class="step-content gap-10 h-[600px]">
            <div class="flex-1 bg-white p-6 rounded-[3rem] shadow-inner relative flex items-center justify-center border-4 border-dashed border-slate-200 overflow-hidden bg-slate-50">
                <img id="inpaintingImage" src="" class="max-w-full max-h-full rounded-2xl shadow-2xl object-contain">
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-48 h-48 border-4 border-red-500 bg-red-500/10 rounded-full animate-pulse flex items-center justify-center">
                        <span class="text-red-500 font-bold text-sm bg-white px-2 py-1 rounded-full shadow-sm">Edit Area Selection</span>
                    </div>
                </div>
            </div>
            
            <div class="w-[400px] flex flex-col gap-4">
                <h2 class="text-2xl font-bold">4ë‹¨ê³„. ì •ë°€ ìˆ˜ì • (In-painting)</h2>
                <div class="bg-white rounded-[2rem] border shadow-sm p-6 flex-1 flex flex-col min-h-0">
                    <div class="flex items-center justify-between mb-4 pb-2 border-b border-slate-100">
                        <span class="text-xs font-bold text-slate-400 uppercase">Revision History</span>
                        <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full font-bold">Session Active</span>
                    </div>
                    <div id="editHistory" class="flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-hide">
                        <div class="p-3 bg-slate-50 rounded-xl text-sm border-l-4 border-emerald-400 text-slate-600">
                            <span class="font-bold block mb-1">System</span>
                            ì´ˆì•ˆ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì •í•  ë¶€ë¶„ì„ ë§ì”€í•´ì£¼ì„¸ìš”.
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <textarea id="editInput" class="w-full h-28 p-4 bg-white border-2 border-slate-200 rounded-2xl text-sm outline-none focus:border-indigo-500 resize-none shadow-sm transition-colors" placeholder="ì˜ˆ: ë°°ê²½ì„ ë°¤ìœ¼ë¡œ ë°”ê¿”ì¤˜"></textarea>
                    <button onclick="applyEdit()" class="absolute right-3 bottom-3 bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold text-xs hover:bg-indigo-700 shadow-md">ì ìš©</button>
                </div>
                
                <button onclick="nextStep(5)" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold text-lg hover:bg-black transition">ìµœì¢…ë³¸ ì €ì¥í•˜ëŸ¬ ê°€ê¸°</button>
            </div>
        </div>

        <div id="step5" class="step-content flex-col items-center justify-center text-center py-10 gap-8">
            <div class="w-28 h-28 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-5xl shadow-xl animate-[bounce_1s_infinite]">âœ“</div>
            <div class="space-y-2">
                <h2 class="text-4xl font-black tracking-tighter text-slate-800">ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                <p class="text-xl text-slate-400 font-medium">Safe for Education â€¢ High Resolution</p>
            </div>
            
            <div class="w-full max-w-lg bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">Download Options</label>
                <div class="flex gap-4">
                    <select id="downloadFormat" class="flex-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-700 outline-none focus:border-indigo-500">
                        <option value="png">PNG (ê³ í™”ì§ˆ/ì¸ì‡„ìš©)</option>
                        <option value="jpeg">JPG (ì¼ë°˜/ì›¹ìš©)</option>
                    </select>
                    <button onclick="downloadFinalImage()" class="flex-[2] bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-black text-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                        <span>ğŸ“¥</span> ì´ë¯¸ì§€ ì €ì¥í•˜ê¸°
                    </button>
                </div>
                <p class="text-xs text-slate-400 mt-4">* ì¸ì‡„ë¬¼ ì œì‘ ì‹œ PNG í˜•ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
            </div>

            <button onclick="location.reload()" class="mt-4 px-8 py-3 rounded-full text-slate-500 font-bold hover:bg-slate-200 transition">ìƒˆë¡œìš´ ì‘ì—… ì‹œì‘í•˜ê¸° â†º</button>
        </div>

    </main>

    <script>
        let currentStep = 1;
        let selectedStyle = 'Photorealistic, 8k, highly detailed'; // ê¸°ë³¸ê°’
        let finalPrompt = ""; // ìµœì¢… í”„ë¡¬í”„íŠ¸ ì €ì¥ìš©

        // 1. ìŠ¤íƒ€ì¼ ì„ íƒ
        function selectStyle(el, styleKeyword) {
            document.querySelectorAll('.style-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedStyle = styleKeyword;
        }

        // 2. íƒ­ ì „í™˜
        function switchTab(mode) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            document.getElementById('tab-'+mode).classList.add('active-tab');
            document.getElementById('content-free').classList.toggle('hidden', mode === 'structured');
            document.getElementById('content-structured').classList.toggle('hidden', mode === 'free');
            if(mode === 'structured') document.getElementById('finalGenBtn').classList.remove('hidden');
        }

        // 3. ì±„íŒ… ì—”ì§„ (í”„ë¡¬í”„íŠ¸ ì €ì¥ ë¡œì§ ì¶”ê°€)
        function sendMessage() {
            const input = document.getElementById('freeInput');
            const chatWindow = document.getElementById('chatWindow');
            if(!input.value.trim()) return;

            finalPrompt = input.value; // ì‚¬ìš©ìì˜ ìµœì‹  ì…ë ¥ì„ í”„ë¡¬í”„íŠ¸ë¡œ ì €ì¥

            chatWindow.innerHTML += `<div class="chat-bubble user-bubble">${input.value}</div>`;
            input.value = "";
            chatWindow.scrollTop = chatWindow.scrollHeight;

            setTimeout(() => {
                const aiResponse = `
                    <div class="chat-bubble ai-bubble">
                        <strong>âœ… ë‚´ìš© í™•ì¸!</strong><br>
                        "${finalPrompt}" ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>
                        ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒì„±ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.
                    </div>
                `;
                chatWindow.innerHTML += aiResponse;
                chatWindow.scrollTop = chatWindow.scrollHeight;
                document.getElementById('finalGenBtn').classList.remove('hidden');
            }, 600);
        }

        // 4. ë‹¨ê³„ ì´ë™
        function nextStep(n) {
            currentStep = n;
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + n).classList.add('active');
            updateNav(n);

            // 3ë‹¨ê³„ ì§„ì… ì‹œ ì´ë¯¸ì§€ ìƒì„± íŠ¸ë¦¬ê±°
            if(n === 3) {
                generateImageWithPollinations();
            }
            if(n === 4) {
                document.getElementById('inpaintingImage').src = document.getElementById('resultImage').src;
            }
            window.scrollTo(0, 0);
        }

        function updateNav(n) {
            for(let i=1; i<=5; i++) {
                const nav = document.getElementById('nav'+i);
                if(i === n) nav.className = "px-4 py-2 rounded-full text-xs font-bold bg-indigo-600 text-white shadow-lg transition-all";
                else if (i < n) nav.className = "px-4 py-2 rounded-full text-xs font-bold bg-indigo-50 text-indigo-600 transition-all";
                else nav.className = "px-4 py-2 rounded-full text-xs font-bold text-slate-400 bg-slate-100 transition-all";
            }
        }

        // 5. í•µì‹¬: Pollinations AI ì´ë¯¸ì§€ ìƒì„±
        function toggleTweak() {
            document.getElementById('tweakArea').classList.toggle('hidden');
            // Tweakì°½ì— í˜„ì¬ í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ ë„£ì–´ì£¼ê¸°
            document.getElementById('tweakInput').value = finalPrompt;
        }

        function regenerateImage(isTweak) {
            if(isTweak) {
                finalPrompt = document.getElementById('tweakInput').value;
            }
            generateImageWithPollinations();
        }

        function generateImageWithPollinations() {
            const loader = document.getElementById('imageLoading');
            const img = document.getElementById('resultImage');
            
            // ë¡œë”© ì¼œê¸°
            loader.style.display = 'flex';
            setTimeout(() => loader.style.opacity = '1', 10);
            
            // 1. ë¹„ìœ¨ ì„¤ì • ê³„ì‚°
            const ratioVal = document.getElementById('aspectRatio').value;
            let width = 1024, height = 1024;
            if(ratioVal === '4:3') { width = 1024; height = 768; }
            else if(ratioVal === '16:9') { width = 1024; height = 576; }
            else if(ratioVal === '2:3') { width = 768; height = 1152; }

            // 2. í”„ë¡¬í”„íŠ¸ êµ¬ì„± (Structured ëª¨ë“œì¼ ê²½ìš° ì¡°í•©)
            if(!finalPrompt) {
                // Structured ëª¨ë“œì—ì„œ ë„˜ì–´ì™”ê±°ë‚˜ ì…ë ¥ì´ ì—†ì„ ê²½ìš° ì¡°í•©
                const s1 = document.getElementById('s_subject').value;
                const s2 = document.getElementById('s_action').value;
                const s3 = document.getElementById('s_location').value;
                if(s1 || s2) finalPrompt = `${s1} ${s2} in ${s3}`;
                else finalPrompt = "Cute educational character illustration"; // fallback
            }

            // ìµœì¢… ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ì¡°í•© (ìŠ¤íƒ€ì¼ + ì‚¬ìš©ìì…ë ¥ + ë³´ì •)
            // í•œê¸€ ì…ë ¥ë„ Pollinationsê°€ ì–´ëŠì •ë„ ì´í•´í•˜ì§€ë§Œ, ì˜ë¬¸ í‚¤ì›Œë“œë¥¼ ë¶™ì—¬ì£¼ëŠ”ê²Œ í€„ë¦¬í‹°ê°€ ì¢‹ìŒ
            const combinedPrompt = `${selectedStyle}, ${finalPrompt}, high quality, educational illustration, detailed, 8k`;
            const encodedPrompt = encodeURIComponent(combinedPrompt);
            const randomSeed = Math.floor(Math.random() * 99999);

            // 3. URL ìƒì„± ë° í• ë‹¹
            const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${width}&height=${height}&seed=${randomSeed}&nologo=true&model=flux`;

            img.onload = function() {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    if(document.getElementById('tweakArea')) document.getElementById('tweakArea').classList.add('hidden');
                }, 300);
            };
            
            // CORS ì„¤ì • (HTMLíƒœê·¸ì—ë„ ìˆì§€ë§Œ JSë¡œ ì¬í™•ì¸)
            img.crossOrigin = "Anonymous";
            img.src = imageUrl;
        }

        // 6. ì¸í˜ì¸íŒ… ì‹œë®¬ë ˆì´ì…˜
        function applyEdit() {
            const input = document.getElementById('editInput');
            const history = document.getElementById('editHistory');
            if(!input.value.trim()) return;

            const userMsg = input.value;
            history.innerHTML += `<div class="p-3 bg-indigo-50 rounded-xl text-sm border-l-4 border-indigo-600 text-slate-700 font-bold mb-2">User: ${userMsg}</div>`;
            input.value = "";
            history.scrollTop = history.scrollHeight;

            setTimeout(() => {
                history.innerHTML += `<div class="p-3 bg-slate-50 rounded-xl text-sm border-l-4 border-emerald-400 text-slate-600">System: ìˆ˜ì • ìš”ì²­ì´ ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)</div>`;
                history.scrollTop = history.scrollHeight;
            }, 800);
        }

        // 7. [ì‹ ê·œ ê¸°ëŠ¥] ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (PNG/JPG ë³€í™˜)
        async function downloadFinalImage() {
            const format = document.getElementById('downloadFormat').value; // 'png' or 'jpeg'
            const imgElement = document.getElementById('resultImage');
            const imgUrl = imgElement.src;
            
            if (!imgUrl) {
                alert("ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ìº”ë²„ìŠ¤ ìƒì„±í•˜ì—¬ í¬ë§· ë³€í™˜
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // ì´ë¯¸ì§€ í¬ê¸°ë§Œí¼ ìº”ë²„ìŠ¤ ì„¤ì •
            canvas.width = imgElement.naturalWidth;
            canvas.height = imgElement.naturalHeight;

            // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¼ (crossOrigin ì´ìŠˆë¥¼ í”¼í•˜ê¸° ìœ„í•´ fetch ì‚¬ìš© ê¶Œì¥ë˜ë‚˜, í˜„ì¬ imgíƒœê·¸ì— crossOriginì´ ìˆì–´ ë°”ë¡œ ê·¸ë¦¬ê¸° ì‹œë„)
            try {
                ctx.drawImage(imgElement, 0, 0);
                
                // ë°ì´í„° URLë¡œ ë³€í™˜ (ì§€ì •ëœ í¬ë§·)
                const dataUrl = canvas.toDataURL(`image/${format}`, 1.0); // 1.0 = ìµœê³  í™”ì§ˆ
                
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­
                const link = document.createElement('a');
                link.download = `EduGen_Image_${new Date().getTime()}.${format}`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                console.error(e);
                alert("ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘ ë³´ì•ˆ ì˜¤ë¥˜(CORS)ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ìš°í´ë¦­í•˜ì—¬ ì €ì¥í•´ì£¼ì„¸ìš”.");
            }
        }
    </script>
</body>
</html>